<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Guide Webzine - Font Restored</title>
    <!-- CSS Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- ì„œì²´ ë¡œë“œ -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        @font-face {
            font-family: 'NanumBarunGothic';
            src: url('https://cdn.jsdelivr.net/gh/nanumfont/nanumfont/NanumBarunGothic.woff') format('woff');
        }
        @font-face {
            font-family: 'MaruBuri';
            src: url('https://cdn.jsdelivr.net/gh/fontsource/maru-buri/fonts/maru-buri-korean-400-normal.woff2') format('woff2');
        }

        /* Quill ì„œì²´ í´ë˜ìŠ¤ ì •ì˜ */
        .ql-font-notosans { font-family: 'Noto Sans KR', sans-serif; }
        .ql-font-nanumgothic { font-family: 'Nanum Gothic', sans-serif; }
        .ql-font-nanummyeongjo { font-family: 'Nanum Myeongjo', serif; }
        .ql-font-nanumbarungothic { font-family: 'NanumBarunGothic', sans-serif; }
        .ql-font-nanumsquare { font-family: 'NanumSquare', sans-serif; }
        .ql-font-maruburi { font-family: 'MaruBuri', serif; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8f9fa;
        }

        #editor-container {
            height: 600px;
            background: white;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .ql-toolbar {
            background: #ffffff;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-color: #e5e7eb !important;
            padding: 12px !important;
        }

        .ql-editor {
            text-align: left; 
            font-family: 'Nanum Gothic', sans-serif;
            font-size: 11pt;
            line-height: 1.6;
        }

        /* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ìŠ¤íƒ€ì¼ */
        .ql-editor img {
            max-width: 100%;
            cursor: pointer;
        }

        /* íˆ´ë°” ë“œë¡­ë‹¤ìš´ í•œê¸€ ë ˆì´ë¸” ì„¤ì • */
        .ql-snow .ql-picker.ql-font .ql-picker-label::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item::before { content: 'ì„œì²´ì„ íƒ'; }
        
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanumgothic"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanumgothic"]::before { content: 'ë‚˜ëˆ”ê³ ë”•'; font-family: 'Nanum Gothic'; }
        
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanummyeongjo"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanummyeongjo"]::before { content: 'ë‚˜ëˆ”ëª…ì¡°'; font-family: 'Nanum Myeongjo'; }
        
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanumbarungothic"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanumbarungothic"]::before { content: 'ë‚˜ëˆ”ë°”ë¥¸ê³ ë”•'; font-family: 'NanumBarunGothic'; }
        
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanumsquare"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanumsquare"]::before { content: 'ë‚˜ëˆ”ìŠ¤í€˜ì–´'; font-family: 'NanumSquare'; }
        
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="maruburi"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="maruburi"]::before { content: 'ë§ˆë£¨ë¶€ë¦¬'; font-family: 'MaruBuri'; }

        .ql-snow .ql-picker.ql-size .ql-picker-label::before,
        .ql-snow .ql-picker.ql-size .ql-picker-item::before { content: attr(data-value) !important; }
        .ql-snow .ql-picker.ql-size .ql-picker-label:not([data-value])::before { content: '11pt' !important; }

        .content-area { text-align: left; word-break: break-all; }
        .content-area img { max-width: 100%; height: auto; margin: 15px 0; }

        #loading-overlay, #modal-login {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
    <p id="loading-text" class="mt-4 font-bold text-white">ì²˜ë¦¬ ì¤‘...</p>
</div>

<div id="modal-login">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
        <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">ê´€ë¦¬ì ì¸ì¦</h2>
        <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 border border-gray-200 rounded-xl mb-6 outline-none focus:ring-2 focus:ring-green-500">
        <div class="flex gap-3">
            <button onclick="closeLoginModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">ì·¨ì†Œ</button>
            <button id="btn-do-login" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="app" class="max-w-5xl mx-auto px-4 py-8">
    <header class="flex justify-between items-center mb-8 border-b pb-6">
        <h1 class="text-3xl font-bold text-gray-800 cursor-pointer" id="logo">ğŸ® GAME <span class="text-green-600">GUIDE</span></h1>
        <nav class="flex gap-3">
            <button id="btn-admin-view" class="bg-gray-800 text-white px-5 py-2 rounded-full font-bold text-sm shadow-sm hover:bg-black">ADMIN</button>
            <button id="btn-write" class="hidden bg-green-600 text-white px-5 py-2 rounded-full font-bold text-sm shadow-md hover:bg-green-700">ê³µëµ ì“°ê¸°</button>
            <button id="btn-logout" class="hidden text-gray-400 hover:text-red-500 text-sm font-bold ml-2">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>
    </header>

    <section id="view-list" class="view">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="post-grid"></div>
    </section>

    <section id="view-detail" class="view hidden">
        <button id="btn-back-list" class="mb-6 text-gray-500 hover:text-black font-medium">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <article class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
            <h2 id="detail-title" class="text-3xl font-bold mb-4"></h2>
            <div id="detail-meta" class="text-sm text-gray-400 mb-8 pb-4 border-b"></div>
            <div id="detail-content" class="content-area"></div>
            <div id="admin-actions" class="hidden mt-10 pt-6 border-t flex gap-4">
                <button id="btn-edit-post" class="text-blue-600 font-bold">ìˆ˜ì •í•˜ê¸°</button>
                <button id="btn-delete-post" class="text-red-500 font-bold">ì‚­ì œí•˜ê¸°</button>
            </div>
        </article>
    </section>

    <section id="view-write" class="view hidden">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <input type="text" id="post-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full text-2xl font-bold mb-6 p-2 border-b-2 border-gray-100 focus:border-green-500 outline-none transition-all">
            <div id="editor-container"></div>
            <input type="file" id="image-input" class="hidden" accept="image/*">
            <div class="mt-8 flex justify-end gap-3">
                <button id="btn-cancel-write" class="px-6 py-2 text-gray-500 font-bold">ì·¨ì†Œ</button>
                <button id="btn-save-post" class="px-10 py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition-all">ë°œí–‰í•˜ê¸°</button>
            </div>
        </div>
    </section>
</div>

<!-- Scripts -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
        authDomain: "octopath-85851.firebaseapp.com",
        projectId: "octopath-85851",
        storageBucket: "octopath-85851.firebasestorage.app",
        messagingSenderId: "744016190979",
        appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "tjsgoehd@gmail.com";

    let isAdmin = false;
    let quill;
    let currentPostId = null;

    // --- Quill ì„œì²´ ë° í¬ê¸° í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë“±ë¡ ---
    const Font = Quill.import('formats/font');
    Font.whitelist = ['nanumgothic', 'nanummyeongjo', 'nanumbarungothic', 'nanumsquare', 'maruburi'];
    Quill.register(Font, true);

    const Size = Quill.import('attributors/style/size');
    Size.whitelist = ['11pt', '13pt', '15pt', '16pt', '19pt', '24pt', '28pt', '30pt', '34pt', '38pt'];
    Quill.register(Size, true);

    function initQuill() {
        quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'ê³µëµ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”...',
            modules: {
                toolbar: {
                    container: [
                        [{ 'font': Font.whitelist }],
                        [{ 'size': Size.whitelist }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['image', 'link', 'blockquote'],
                        ['clean']
                    ],
                    handlers: { image: imageHandler }
                },
                imageResize: { displaySize: true }
            }
        });

        // ì´ˆê¸° ì„œì²´/í¬ê¸° ê¸°ë³¸ê°’ ì„¤ì •
        quill.format('font', 'nanumgothic');
        quill.format('size', '11pt');
    }

    async function imageHandler() {
        const input = document.getElementById('image-input');
        input.value = "";
        input.click();
        input.onchange = () => {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 1024 * 1024) return alert("ì´ë¯¸ì§€ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (1MB ì œí•œ).");
            
            showLoading(true, "ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...");
            const reader = new FileReader();
            reader.onload = (e) => {
                const range = quill.getSelection(true);
                quill.insertEmbed(range.index, 'image', e.target.result);
                quill.setSelection(range.index + 1);
                showLoading(false);
            };
            reader.readAsDataURL(file);
        };
    }

    function showLoading(show, text = "") {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        document.getElementById('loading-text').innerText = text;
    }

    window.showView = (name) => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
        if (name === 'list') fetchPosts();
    };

    async function fetchPosts() {
        const grid = document.getElementById('post-grid');
        grid.innerHTML = '';
        const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        snap.forEach(d => {
            const p = d.data();
            const card = document.createElement('div');
            card.className = "bg-white p-6 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all";
            card.onclick = () => {
                currentPostId = d.id;
                document.getElementById('detail-title').innerText = p.title;
                document.getElementById('detail-content').innerHTML = p.content;
                document.getElementById('detail-meta').innerText = `ê´€ë¦¬ì | ${p.date || ''}`;
                document.getElementById('admin-actions').classList.toggle('hidden', !isAdmin);
                showView('detail');
            };
            card.innerHTML = `
                <h3 class="font-bold text-lg mb-4 line-clamp-2 text-gray-800">${p.title}</h3>
                <div class="flex items-center justify-between text-xs text-gray-400">
                    <span>${p.date || ''}</span>
                    <span class="text-green-600 font-bold uppercase">Guide</span>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    document.getElementById('btn-save-post').onclick = async () => {
        const title = document.getElementById('post-title').value;
        const content = quill.root.innerHTML;
        if (!title || quill.getText().trim().length < 2) return alert("ë‚´ìš©ì„ ì±„ì›Œì£¼ì„¸ìš”.");

        showLoading(true, "ì €ì¥ ì¤‘...");
        try {
            const data = { title, content, updatedAt: serverTimestamp() };
            if (currentPostId) {
                await updateDoc(doc(db, 'posts', currentPostId), data);
            } else {
                data.createdAt = serverTimestamp();
                data.date = new Date().toLocaleDateString('ko-KR');
                await addDoc(collection(db, 'posts'), data);
            }
            showView('list');
        } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        finally { showLoading(false); }
    };

    document.getElementById('btn-admin-view').onclick = () => document.getElementById('modal-login').style.display = 'flex';
    window.closeLoginModal = () => document.getElementById('modal-login').style.display = 'none';
    document.getElementById('btn-do-login').onclick = async () => {
        try {
            await signInWithEmailAndPassword(auth, ADMIN_EMAIL, document.getElementById('admin-password').value);
            closeLoginModal();
        } catch (e) { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
    };
    document.getElementById('btn-logout').onclick = () => signOut(auth);
    document.getElementById('btn-write').onclick = () => {
        currentPostId = null;
        document.getElementById('post-title').value = '';
        quill.setContents([]);
        quill.format('font', 'nanumgothic');
        quill.format('size', '11pt');
        showView('write');
    };
    document.getElementById('btn-edit-post').onclick = () => {
        document.getElementById('post-title').value = document.getElementById('detail-title').innerText;
        quill.root.innerHTML = document.getElementById('detail-content').innerHTML;
        showView('write');
    };
    document.getElementById('btn-delete-post').onclick = async () => {
        if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await deleteDoc(doc(db, 'posts', currentPostId));
            showView('list');
        }
    };
    document.getElementById('btn-back-list').onclick = () => showView('list');
    document.getElementById('btn-cancel-write').onclick = () => showView('list');
    document.getElementById('logo').onclick = () => showView('list');

    onAuthStateChanged(auth, (user) => {
        isAdmin = user && user.email === ADMIN_EMAIL;
        document.getElementById('btn-write').classList.toggle('hidden', !isAdmin);
        document.getElementById('btn-logout').classList.toggle('hidden', !isAdmin);
        document.getElementById('btn-admin-view').classList.toggle('hidden', isAdmin);
        fetchPosts();
    });

    initQuill();
</script>
</body>
</html>
