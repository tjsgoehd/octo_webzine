<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Guide Webzine - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ì„œì²´ ë¡œë“œ -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css">
    <!-- CKEditor 5 Superbuild ë¡œë“œ -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/super-build/ckeditor.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        
        :root {
            --brand-color: #10b981;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body {
            font-family: 'SUIT Variable', 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            letter-spacing: -0.01em;
            word-break: keep-all;
            margin: 0;
        }

        .max-content-width {
            max-width: 860px;
            margin-left: auto;
            margin-right: auto;
        }

        /* CKEditor UI í…Œë§ˆ ë§ì¶¤ ì¡°ì • */
        .ck-editor__editable {
            min-height: 500px !important;
            padding: 40px !important;
            line-height: 1.85 !important;
            font-size: 15px;
            color: #334155 !important;
            border: none !important;
            box-shadow: none !important;
        }
        .ck.ck-editor__main>.ck-editor__editable:not(.ck-focused) {
            border: none !important;
        }
        .ck.ck-toolbar {
            background: #f8fafc !important;
            border: none !important;
            border-bottom: 1px solid #e2e8f0 !important;
            padding: 10px !important;
            position: sticky !important;
            top: 64px !important;
            z-index: 10 !important;
        }

        /* ì´ë¯¸ì§€ ê¸°ë³¸ ì •ë ¬ ìŠ¤íƒ€ì¼ (ì¢Œì¸¡ ì •ë ¬ ê¸°ë³¸í™”) */
        .ck-content .image { 
            margin: 1.5rem 0 !important; 
            display: table !important; 
            clear: both; 
            text-align: left !important;
        }
        .ck-content .image-style-side {
            float: right;
            margin-left: var(--ck-image-style-spacing);
        }
        .ck-content .image-style-block-align-left {
            margin-left: 0;
            margin-right: auto;
        }
        
        .ck-content img { border-radius: 16px !important; max-width: 100%; height: auto !important; }
        
        /* ë·°ì–´ ë‚´ë¶€ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© */
        .ck-content { font-size: 16px; line-height: 1.8; }

        .post-card {
            background: var(--card-bg);
            border: 1px solid rgba(226, 232, 240, 0.6);
            border-radius: 24px;
            padding: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.08);
            border-color: var(--brand-color);
        }

        .post-viewer {
            background: var(--card-bg);
            border-radius: 32px;
            box-shadow: 0 20px 40px -20px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="w-12 h-12 border-4 border-slate-200 border-t-emerald-500 rounded-full animate-spin"></div>
    <p class="mt-4 font-semibold text-slate-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
</div>

<div id="app" class="pb-24">
    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-100">
        <div class="max-content-width px-6 h-16 flex justify-between items-center">
            <div id="logo" class="flex items-center gap-2 cursor-pointer group">
                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white font-bold group-hover:rotate-12 transition-transform">G</div>
                <span class="text-lg font-black tracking-tight text-slate-800">GAME<span class="text-emerald-500">LAB</span></span>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-admin-view" class="text-xs font-bold text-slate-400 hover:text-emerald-500 transition-colors uppercase tracking-widest">Admin</button>
                <button id="btn-write" class="hidden flex items-center gap-2 bg-slate-900 text-white px-5 py-2 rounded-full font-bold text-sm hover:bg-emerald-600 shadow-lg shadow-emerald-500/10 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                    ê³µëµ ì‘ì„±
                </button>
                <button id="btn-logout" class="hidden text-xs text-rose-500 font-bold hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <main id="view-list" class="view max-content-width px-6 mt-12">
        <header class="mb-8">
            <h2 class="text-3xl font-bold text-slate-900">ìµœì‹  ê³µëµ ë¦¬ìŠ¤íŠ¸</h2>
            <p class="text-slate-500 mt-1">ì „ë¬¸ ì—ë””í„°ì˜ ê¹Šì´ ìˆëŠ” ê³µëµì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </header>
        <div class="grid grid-cols-1 gap-6" id="post-grid"></div>
    </main>

    <main id="view-detail" class="view hidden max-content-width px-6 mt-10">
        <div class="flex justify-between items-center mb-6">
            <button id="btn-back-list" class="group flex items-center gap-2 text-slate-400 hover:text-slate-900 font-bold transition-colors">
                <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                ëª©ë¡ìœ¼ë¡œ
            </button>
            <div id="admin-top-controls" class="hidden flex gap-2">
                <button id="btn-edit-top" class="text-xs font-bold bg-slate-100 text-slate-600 px-4 py-2 rounded-full hover:bg-emerald-50 hover:text-emerald-600 transition-colors">ê¸€ ìˆ˜ì •</button>
                <button id="btn-delete-top" class="text-xs font-bold bg-slate-100 text-slate-600 px-4 py-2 rounded-full hover:bg-rose-50 hover:text-rose-600 transition-colors">ì‚­ì œ</button>
            </div>
        </div>
        
        <article class="post-viewer overflow-hidden">
            <div class="p-12 pb-8">
                <h1 id="detail-title" class="text-4xl font-extrabold text-slate-900 leading-tight mb-8"></h1>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-xl">ğŸ¦…</div>
                        <div>
                            <p class="text-sm font-bold text-slate-800">ì€ë¹›ë…ìˆ˜ë¦¬</p>
                            <p class="text-xs text-slate-400">ìµœì¢… ê°±ì‹ : <span id="detail-date"></span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-slate-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        <span id="detail-views" class="text-sm font-bold">0</span>
                    </div>
                </div>
            </div>
            <div class="h-px bg-slate-100 mx-12"></div>
            <div id="detail-content" class="ck-content p-12 min-h-[400px]"></div>
        </article>
    </main>

    <main id="view-write" class="view hidden max-content-width px-6 mt-10">
        <div class="bg-white rounded-[32px] shadow-2xl border border-slate-100 overflow-hidden">
            <div class="p-10 pb-4">
                <input type="text" id="post-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full text-4xl font-black outline-none border-none placeholder:text-slate-200 text-slate-800 bg-transparent">
            </div>
            
            <div id="editor-container">
                <div id="editor"></div>
            </div>

            <div class="p-8 bg-slate-50 flex justify-end gap-4">
                <button id="btn-cancel-write" class="px-6 py-3 font-bold text-slate-400 hover:text-slate-800">ì·¨ì†Œ</button>
                <button id="btn-save-post" class="bg-emerald-500 text-white px-10 py-4 rounded-2xl font-black text-lg shadow-xl shadow-emerald-500/20 hover:bg-emerald-600 transition-all">ê³µëµ ë°œí–‰í•˜ê¸°</button>
            </div>
        </div>
    </main>
</div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="modal-login" class="fixed inset-0 bg-slate-900/60 hidden z-[100] flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white rounded-[32px] p-10 w-full max-w-sm shadow-2xl">
        <h3 class="text-xl font-black mb-6 text-center text-slate-800">Admin Login</h3>
        <input type="password" id="admin-password" placeholder="Passcode" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl mb-4 outline-none focus:border-emerald-500 focus:bg-white text-center font-bold tracking-widest">
        <button id="btn-do-login" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-emerald-600 transition-colors">ë¡œê·¸ì¸</button>
        <button id="btn-close-login" class="w-full py-3 font-bold text-slate-400 mt-2">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, orderBy, query, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
        authDomain: "octopath-85851.firebaseapp.com",
        projectId: "octopath-85851",
        storageBucket: "octopath-85851.firebasestorage.app",
        messagingSenderId: "744016190979",
        appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    const ADMIN_EMAIL = "tjsgoehd@gmail.com";

    let isAdmin = false;
    let editorInstance = null;
    let currentPostId = null;

    // CKEditor 5 ì´ˆê¸°í™”
    async function initCKEditor() {
        const editorElement = document.querySelector('#editor');
        
        let retryCount = 0;
        while (typeof CKEDITOR === 'undefined' && retryCount < 50) {
            await new Promise(r => setTimeout(r, 100));
            retryCount++;
        }

        if (!editorElement || typeof CKEDITOR === 'undefined') {
            console.error('CKEDITOR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
            return;
        }

        try {
            editorInstance = await CKEDITOR.ClassicEditor.create(editorElement, {
                removePlugins: [
                    'AIAssistant', 'CKBox', 'CKFinder', 'EasyImage', 'RealTimeCollaborativeComments',
                    'RealTimeCollaborativeTrackChanges', 'RealTimeCollaborativeRevisionHistory',
                    'PresenceList', 'Comments', 'TrackChanges', 'TrackChangesData',
                    'RevisionHistory', 'Pagination', 'WProofreader', 'MathType', 'SlashCommand',
                    'Template', 'DocumentOutline', 'FormatPainter', 'TableOfContents', 
                    'PasteFromOfficeEnhanced', 'CaseChange', 'ExportPdf', 'ExportWord', 'MultiLevelLists'
                ],
                toolbar: {
                    items: [
                        'undo', 'redo', '|',
                        'fontFamily', 'fontSize', 'fontColor', 'fontBackgroundColor', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|',
                        'alignment', '|',
                        'bulletedList', 'numberedList', '|',
                        'insertTable', 'imageUpload', 'horizontalLine', '|',
                        'removeFormat'
                    ],
                    shouldNotGroupWhenFull: true
                },
                language: 'ko',
                image: {
                    // ì´ë¯¸ì§€ ì‚½ì… ì‹œ ê¸°ë³¸ ì„¤ì •ì„ ì¢Œì¸¡ ì •ë ¬(inline í˜¹ì€ align-left)ë¡œ ìœ ë„
                    insert: {
                        type: 'auto'
                    },
                    toolbar: [
                        'imageStyle:inline', 'imageStyle:block', 'imageStyle:side', '|',
                        'toggleImageCaption', 'imageTextAlternative'
                    ],
                    // ìŠ¤íƒ€ì¼ ì •ì˜ë¥¼ í†µí•´ ê¸°ë³¸ê°’ì„ ì¢Œì¸¡ìœ¼ë¡œ ìœ ë„
                    styles: [
                        'full', 'side', 'alignLeft', 'alignCenter', 'alignRight'
                    ]
                },
                extraPlugins: [ MyCustomUploadAdapterPlugin ]
            });
        } catch (error) {
            console.error('CKEditor ì´ˆê¸°í™” ì—ëŸ¬:', error);
        }
    }

    function MyCustomUploadAdapterPlugin( editor ) {
        editor.plugins.get( 'FileRepository' ).createUploadAdapter = ( loader ) => {
            return {
                upload: () => loader.file.then( file => new Promise( ( resolve, reject ) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve( { default: reader.result } );
                    reader.onerror = reject;
                    reader.readAsDataURL( file );
                } ) )
            };
        };
    }

    const showView = (name) => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        const target = document.getElementById(`view-${name}`);
        if(target) target.classList.remove('hidden');
        window.scrollTo(0, 0);
        if (name === 'list') fetchPosts();
    };

    async function fetchPosts() {
        const grid = document.getElementById('post-grid');
        if (!grid) return;
        grid.innerHTML = '';
        showLoading(true);
        try {
            const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            snap.forEach(d => {
                const p = d.data();
                const card = document.createElement('div');
                card.className = "post-card";
                card.onclick = () => openDetail(d.id, p);
                card.innerHTML = `
                    <div class="flex items-center gap-2 mb-4">
                        <span class="px-3 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-black rounded-full uppercase tracking-wider">Strategy</span>
                        <span class="text-[11px] text-slate-300 font-medium">${p.date || ''}</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 line-clamp-2 leading-snug mb-6">${p.title}</h3>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-slate-100 rounded-full flex items-center justify-center text-[10px]">ğŸ¦…</div>
                            <span class="text-sm font-bold text-slate-600">ì€ë¹›ë…ìˆ˜ë¦¬</span>
                        </div>
                        <div class="text-xs font-bold text-slate-400">ì¡°íšŒ ${p.views || 0}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (e) {
            console.error("ë°ì´í„° ë¡œë“œ ì—ëŸ¬:", e);
        } finally { showLoading(false); }
    }

    async function openDetail(id, p) {
        currentPostId = id;
        document.getElementById('detail-title').innerText = p.title;
        document.getElementById('detail-content').innerHTML = p.content;
        document.getElementById('detail-date').innerText = p.date || '';
        document.getElementById('detail-views').innerText = (p.views || 0) + 1;
        
        document.getElementById('admin-top-controls').classList.toggle('hidden', !isAdmin);
        showView('detail');
        updateDoc(doc(db, 'posts', id), { views: increment(1) });
    }

    function showLoading(show) {
        const loader = document.getElementById('loading-overlay');
        if (loader) loader.style.display = show ? 'flex' : 'none';
    }

    document.getElementById('btn-save-post').onclick = async () => {
        const title = document.getElementById('post-title').value;
        const content = editorInstance ? editorInstance.getData() : '';
        const now = new Date();
        const formattedDate = `${now.getFullYear()}. ${String(now.getMonth() + 1).padStart(2, '0')}. ${String(now.getDate()).padStart(2, '0')}. ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        if (!title.trim()) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        showLoading(true);
        try {
            if (currentPostId) {
                await updateDoc(doc(db, 'posts', currentPostId), { 
                    title, content, date: formattedDate, updatedAt: serverTimestamp() 
                });
            } else {
                await addDoc(collection(db, 'posts'), {
                    title, content, views: 0, author: "ì€ë¹›ë…ìˆ˜ë¦¬",
                    date: formattedDate, createdAt: serverTimestamp()
                });
            }
            showView('list');
        } finally { showLoading(false); }
    };

    document.getElementById('btn-admin-view').onclick = () => document.getElementById('modal-login').style.display = 'flex';
    document.getElementById('btn-do-login').onclick = async () => {
        const pw = document.getElementById('admin-password').value;
        try {
            await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pw);
            document.getElementById('modal-login').style.display = 'none';
            document.getElementById('admin-password').value = '';
        } catch (e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); }
    };

    document.getElementById('btn-close-login').onclick = () => document.getElementById('modal-login').style.display = 'none';
    document.getElementById('btn-logout').onclick = () => signOut(auth);
    document.getElementById('btn-write').onclick = () => {
        currentPostId = null;
        document.getElementById('post-title').value = '';
        if (editorInstance) editorInstance.setData('');
        showView('write');
    };

    document.getElementById('btn-edit-top').onclick = () => {
        document.getElementById('post-title').value = document.getElementById('detail-title').innerText;
        if (editorInstance) editorInstance.setData(document.getElementById('detail-content').innerHTML);
        showView('write');
    };

    document.getElementById('btn-delete-top').onclick = async () => {
        if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            showLoading(true);
            await deleteDoc(doc(db, 'posts', currentPostId));
            showView('list');
        }
    };

    document.getElementById('btn-back-list').onclick = () => showView('list');
    document.getElementById('btn-cancel-write').onclick = () => showView('list');
    document.getElementById('logo').onclick = () => showView('list');

    onAuthStateChanged(auth, (user) => {
        isAdmin = user && user.email === ADMIN_EMAIL;
        const writeBtn = document.getElementById('btn-write');
        const logoutBtn = document.getElementById('btn-logout');
        const adminBtn = document.getElementById('btn-admin-view');
        
        if(writeBtn) writeBtn.classList.toggle('hidden', !isAdmin);
        if(logoutBtn) logoutBtn.classList.toggle('hidden', !isAdmin);
        if(adminBtn) adminBtn.classList.toggle('hidden', isAdmin);
        fetchPosts();
    });

    window.addEventListener('load', () => {
        initCKEditor();
    });
</script>
</body>
</html>
