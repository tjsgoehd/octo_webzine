<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Guide Webzine - Premium View</title>
    <!-- CSS Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- ì„œì²´ ë¡œë“œ -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        
        @font-face {
            font-family: 'NanumBarunGothic';
            src: url('https://cdn.jsdelivr.net/gh/nanumfont/nanumfont/NanumBarunGothic.woff') format('woff');
        }
        @font-face {
            font-family: 'MaruBuri';
            src: url('https://cdn.jsdelivr.net/gh/fontsource/maru-buri/fonts/maru-buri-korean-400-normal.woff2') format('woff2');
        }

        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f2f4f7;
            color: #333;
        }

        /* ì»¨í…Œì´ë„ˆ ê°€ë¡œí­ 780px ê³ ì • */
        .max-content-width {
            max-width: 780px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Quill ì„œì²´ í´ë˜ìŠ¤ ì •ì˜ */
        .ql-font-notosans { font-family: 'Noto Sans KR', sans-serif; }
        .ql-font-nanumgothic { font-family: 'Nanum Gothic', sans-serif; }
        .ql-font-nanummyeongjo { font-family: 'Nanum Myeongjo', serif; }
        .ql-font-nanumbarungothic { font-family: 'NanumBarunGothic', sans-serif; }
        .ql-font-nanumsquare { font-family: 'NanumSquare', sans-serif; }
        .ql-font-maruburi { font-family: 'MaruBuri', serif; }

        /* ì—ë””í„° ë†’ì´ ë° ìŠ¤íƒ€ì¼ */
        #editor-container {
            height: 500px;
            background: white;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        
        .ql-toolbar {
            background: #ffffff;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            border-color: #e5e7eb !important;
        }

        /* ìƒì„¸ ë³´ê¸° ë·°ì–´ ìŠ¤íƒ€ì¼ (image_ca8d20 ì°¸ê³ ) */
        .post-viewer {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .post-header {
            padding: 32px 32px 20px 32px;
        }

        .category-path {
            color: #888;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .post-title {
            font-size: 28px;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: 20px;
            color: #111;
        }

        .author-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .author-details {
            flex: 1;
        }

        .author-name {
            font-weight: 700;
            font-size: 15px;
            color: #333;
        }

        .post-meta-sub {
            font-size: 13px;
            color: #999;
            margin-top: 2px;
        }

        .content-area {
            padding: 0 32px 40px 32px;
            line-height: 1.8;
            font-size: 16px;
        }

        .content-area img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 24px 0;
        }

        /* íˆ´ë°” ë“œë¡­ë‹¤ìš´ ë ˆì´ë¸” ë³µêµ¬ */
        .ql-snow .ql-picker.ql-font .ql-picker-label::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item::before { content: 'ì„œì²´ì„ íƒ'; }
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanumgothic"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanumgothic"]::before { content: 'ë‚˜ëˆ”ê³ ë”•'; }
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanummyeongjo"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanummyeongjo"]::before { content: 'ë‚˜ëˆ”ëª…ì¡°'; }
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanumbarungothic"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanumbarungothic"]::before { content: 'ë‚˜ëˆ”ë°”ë¥¸ê³ ë”•'; }
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="nanumsquare"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="nanumsquare"]::before { content: 'ë‚˜ëˆ”ìŠ¤í€˜ì–´'; }
        .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="maruburi"]::before,
        .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="maruburi"]::before { content: 'ë§ˆë£¨ë¶€ë¦¬'; }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600"></div>
    <p id="loading-text" class="mt-4 font-medium text-gray-600">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<div id="app" class="pb-20">
    <!-- í—¤ë” -->
    <header class="bg-white border-b sticky top-0 z-50 mb-8">
        <div class="max-content-width px-4 h-16 flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tighter text-gray-900 cursor-pointer" id="logo">
                ğŸ® GAME <span class="text-green-600 font-normal">GUIDE</span>
            </h1>
            <div class="flex items-center gap-4">
                <button id="btn-admin-view" class="text-xs font-bold text-gray-400 hover:text-black">ADMIN</button>
                <button id="btn-write" class="hidden bg-green-600 text-white px-4 py-2 rounded-full font-bold text-sm shadow-sm">ê³µëµ ì“°ê¸°</button>
                <button id="btn-logout" class="hidden text-xs text-red-400 font-bold">LOGOUT</button>
            </div>
        </div>
    </header>

    <!-- ëª©ë¡ ë·° -->
    <main id="view-list" class="view max-content-width px-4">
        <div class="grid grid-cols-1 gap-4" id="post-grid">
            <!-- ì¹´ë“œ í˜•íƒœì˜ ëª©ë¡ -->
        </div>
    </main>

    <!-- ìƒì„¸ ë³´ê¸° ë·° (image_ca8d20 ë””ìì¸) -->
    <main id="view-detail" class="view hidden max-content-width px-4">
        <button id="btn-back-list" class="mb-4 text-sm text-gray-400 hover:text-black">â† ëª©ë¡</button>
        
        <article class="post-viewer">
            <div class="post-header">
                <div class="category-path">
                    ì½œë¼ë³´ í”Œë ˆì´ ì¸ì¦ ì´ë²¤íŠ¸ <span class="text-gray-300">â€º</span>
                </div>
                <h2 id="detail-title" class="post-title"></h2>
                
                <div class="flex justify-between items-end">
                    <div class="author-info">
                        <div class="author-avatar">ğŸ¦‰</div>
                        <div class="author-details">
                            <div class="author-name">ì€ë¹›ë…ìˆ˜ë¦¬ <span class="text-[10px] bg-gray-100 text-gray-500 px-1 rounded ml-1">LV 15</span></div>
                            <div class="post-meta-sub">
                                <span id="detail-date"></span> Â· ì¡°íšŒ <span id="detail-views">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer hover:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                    </div>
                </div>
            </div>

            <div id="detail-content" class="content-area ql-editor">
                <!-- ë³¸ë¬¸ ë‚´ìš© -->
            </div>
            
            <div class="px-8 pb-8 flex justify-between items-center text-xs text-gray-300 border-t pt-6 mx-8">
                <div id="detail-uid">uid : 394296475</div>
                <div id="admin-controls" class="hidden flex gap-3">
                    <button id="btn-edit-post" class="text-blue-500 font-bold underline">ìˆ˜ì •</button>
                    <button id="btn-delete-post" class="text-red-400 font-bold underline">ì‚­ì œ</button>
                </div>
            </div>
        </article>
    </main>

    <!-- ì‘ì„± ë·° -->
    <main id="view-write" class="view hidden max-content-width px-4">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-6 border-b">
                <input type="text" id="post-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full text-2xl font-bold outline-none">
            </div>
            <div id="editor-container"></div>
            <input type="file" id="image-input" class="hidden" accept="image/*">
            <div class="p-6 bg-gray-50 flex justify-end gap-3">
                <button id="btn-cancel-write" class="px-6 py-2 text-gray-400 font-bold">ì·¨ì†Œ</button>
                <button id="btn-save-post" class="px-8 py-2 bg-green-600 text-white font-bold rounded-xl">ë°œí–‰í•˜ê¸°</button>
            </div>
        </div>
    </main>
</div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="modal-login" class="fixed inset-0 bg-black/60 hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
        <h3 class="text-xl font-bold mb-6 text-center">ê´€ë¦¬ì ì¸ì¦</h3>
        <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-4 bg-gray-50 border-none rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-green-500">
        <div class="flex gap-2">
            <button onclick="document.getElementById('modal-login').style.display='none'" class="flex-1 py-4 font-bold text-gray-400">ë‹«ê¸°</button>
            <button id="btn-do-login" class="flex-1 py-4 bg-green-600 text-white rounded-2xl font-bold">ì¸ì¦í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, orderBy, query, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
        authDomain: "octopath-85851.firebaseapp.com",
        projectId: "octopath-85851",
        storageBucket: "octopath-85851.firebasestorage.app",
        messagingSenderId: "744016190979",
        appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "tjsgoehd@gmail.com";

    let isAdmin = false;
    let quill;
    let currentPostId = null;

    // --- Quill ì´ˆê¸°í™” ë° ì„œì²´ ë“±ë¡ ---
    const Font = Quill.import('formats/font');
    Font.whitelist = ['nanumgothic', 'nanummyeongjo', 'nanumbarungothic', 'nanumsquare', 'maruburi'];
    Quill.register(Font, true);

    function initQuill() {
        quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [
                        [{ 'font': Font.whitelist }],
                        [{ 'size': ['11pt', '13pt', '16pt', '19pt', '24pt'] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'color': [] }, { 'align': [] }],
                        ['image', 'blockquote', 'code-block'],
                        ['clean']
                    ],
                    handlers: { image: imageHandler }
                },
                imageResize: { displaySize: true }
            }
        });
        quill.format('font', 'nanumgothic');
    }

    async function imageHandler() {
        const input = document.getElementById('image-input');
        input.click();
        input.onchange = () => {
            const file = input.files[0];
            if (file && file.size < 1.5 * 1024 * 1024) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const range = quill.getSelection(true);
                    quill.insertEmbed(range.index, 'image', e.target.result);
                };
                reader.readAsDataURL(file);
            } else { alert("1.5MB ì´í•˜ì˜ ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); }
        };
    }

    window.showView = (name) => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
        window.scrollTo(0, 0);
        if (name === 'list') fetchPosts();
    };

    async function fetchPosts() {
        const grid = document.getElementById('post-grid');
        grid.innerHTML = '';
        showLoading(true);
        try {
            const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            snap.forEach(d => {
                const p = d.data();
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl border border-gray-100 cursor-pointer hover:border-green-200 transition-all";
                card.onclick = () => openDetail(d.id, p);
                card.innerHTML = `
                    <div class="text-[11px] text-green-600 font-bold mb-2">GUIDE</div>
                    <h3 class="font-bold text-lg text-gray-800 line-clamp-1">${p.title}</h3>
                    <div class="mt-4 flex justify-between items-center text-xs text-gray-400">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-600">ì€ë¹›ë…ìˆ˜ë¦¬</span>
                            <span>${p.date || ''}</span>
                        </div>
                        <div>ì¡°íšŒ ${p.views || 0}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        } finally { showLoading(false); }
    }

    async function openDetail(id, p) {
        currentPostId = id;
        document.getElementById('detail-title').innerText = p.title;
        document.getElementById('detail-content').innerHTML = p.content;
        document.getElementById('detail-date').innerText = p.date || '';
        document.getElementById('detail-views').innerText = (p.views || 0) + 1;
        document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
        showView('detail');
        
        // ì¡°íšŒìˆ˜ ì¦ê°€ (ë¹„ë™ê¸°)
        updateDoc(doc(db, 'posts', id), { views: increment(1) });
    }

    function showLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('btn-save-post').onclick = async () => {
        const title = document.getElementById('post-title').value;
        const content = quill.root.innerHTML;
        if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        showLoading(true);
        try {
            if (currentPostId) {
                await updateDoc(doc(db, 'posts', currentPostId), { title, content, updatedAt: serverTimestamp() });
            } else {
                await addDoc(collection(db, 'posts'), {
                    title, content, views: 0, author: "ì€ë¹›ë…ìˆ˜ë¦¬",
                    date: new Date().toLocaleDateString('ko-KR'),
                    createdAt: serverTimestamp()
                });
            }
            showView('list');
        } finally { showLoading(false); }
    };

    document.getElementById('btn-admin-view').onclick = () => document.getElementById('modal-login').style.display = 'flex';
    document.getElementById('btn-do-login').onclick = async () => {
        const pw = document.getElementById('admin-password').value;
        try {
            await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pw);
            document.getElementById('modal-login').style.display = 'none';
        } catch (e) { alert("ì¸ì¦ ì‹¤íŒ¨"); }
    };

    document.getElementById('btn-logout').onclick = () => signOut(auth);
    document.getElementById('btn-write').onclick = () => {
        currentPostId = null;
        document.getElementById('post-title').value = '';
        quill.setContents([]);
        showView('write');
    };
    document.getElementById('btn-edit-post').onclick = () => {
        document.getElementById('post-title').value = document.getElementById('detail-title').innerText;
        quill.root.innerHTML = document.getElementById('detail-content').innerHTML;
        showView('write');
    };
    document.getElementById('btn-delete-post').onclick = async () => {
        if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await deleteDoc(doc(db, 'posts', currentPostId));
            showView('list');
        }
    };
    
    document.getElementById('btn-back-list').onclick = () => showView('list');
    document.getElementById('btn-cancel-write').onclick = () => showView('list');
    document.getElementById('logo').onclick = () => showView('list');

    onAuthStateChanged(auth, (user) => {
        isAdmin = user && user.email === ADMIN_EMAIL;
        document.getElementById('btn-write').classList.toggle('hidden', !isAdmin);
        document.getElementById('btn-logout').classList.toggle('hidden', !isAdmin);
        document.getElementById('btn-admin-view').classList.toggle('hidden', isAdmin);
        fetchPosts();
    });

    initQuill();
</script>
</body>
</html>
